<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="altrepr">
<title>Memory Maps • altrepr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Memory Maps">
<meta property="og:description" content="altrepr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">altrepr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/altrepr.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/altrep_anatomy.html">ALTREP Anatomy</a>
    <a class="dropdown-item" href="../articles/deferred_string.html">Deferred Strings</a>
    <a class="dropdown-item" href="../articles/memmap.html">Memory Maps</a>
    <a class="dropdown-item" href="../articles/wrapper_objects.html">Wrapper Objects</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Memory Maps</h1>
            
      
      
      <div class="d-none name"><code>memmap.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><em>Note: you should have read <code><a href="../articles/altrepr.html">vignette("altrepr")</a></code> in
order to understand this one</em></p>
<p>Memory mapping (memmap) refers to mapping a file on disk to an object
in memory. Data is only loaded from disk as required, meaning that the
entire object can be much larger than there is space for in memory.</p>
<p>Apparently, R contains a family of memmap ALTREP classes that provide
this behaviour.</p>
</div>
<div class="section level2">
<h2 id="creating-a-memory-map">Creating a Memory Map<a class="anchor" aria-label="anchor" href="#creating-a-memory-map"></a>
</h2>
<p>Seemingly, the only interface for the memmap classes provided by R is
another internal function. In other words, memmap classes have no public
constructor in R yet.</p>
<p>That doesn’t mean that <code>altrepr</code> doesn’t help, though. The
<code><a href="../reference/mmap_make.html">mmap_make()</a></code> function attempts to turn this internal
constructor into something a bit more user friendly.</p>
<p>To test it, we first create a dataset to play with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">data</span></span>
<span><span class="co">#&gt; [1] -0.003720188  0.349344654  1.412407604  0.811939945  1.464386414</span></span></code></pre></div>
<p>Then we write this dataset to a temporary file, and open it as a
memory mapped vector <strong>that exists on disk!</strong></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">altrepr</span><span class="op">)</span></span>
<span><span class="va">filename</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">mapped</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mmap_make.html">mmap_make</a></span><span class="op">(</span><span class="va">filename</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">mapped</span></span>
<span><span class="co">#&gt; [1] -0.003720188  0.349344654  1.412407604  0.811939945  1.464386414</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="prying-into-the-memory-map">Prying into the Memory Map<a class="anchor" aria-label="anchor" href="#prying-into-the-memory-map"></a>
</h2>
<p>The classname is <code>mmap_</code> + data type, which in this case
is <code>real</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/alt_classname.html">alt_classname</a></span><span class="op">(</span><span class="va">mapped</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "mmap_real"</span></span></code></pre></div>
<p>The <code>data1</code> slot is a pointer to the memory map itself, in
memory (although it’s a kind of virtual pointer because the memory
exists on disk):</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/alt_data1.html">alt_data1</a></span><span class="op">(</span><span class="va">mapped</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;pointer: 0x7ff9aa02a000&gt;</span></span></code></pre></div>
<p>The <code>data2</code> slot contains a list, whose entries are<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;&lt;a href="https://github.com/wch/r-source/blob/a0409ebcd1fc16247812d425085c8a3cc4aa4499/src/main/altclasses.c#L927-L949" class="external-link"&gt;altclasses.c#L927-L949&lt;/a&gt;&lt;/p&gt;'><sup>1</sup></a>:</p>
<ol style="list-style-type: decimal">
<li>The name of the file we have memory mapped</li>
<li>A length-2 vector:
<ol style="list-style-type: decimal">
<li>The size of the memory map in bytes</li>
<li>The number of entries in the vector</li>
</ol>
</li>
<li>A length-4 vector:
<ol style="list-style-type: decimal">
<li>The <code>SEXPTYPE</code> of the memory map (either 13 for integer,
or 14 for double)</li>
<li>A boolean called <code>ptrOK</code>. It is unclear what this does or
was planned to do.</li>
<li>A boolean, which is <code>1</code> if the memory map is requested to
be writable</li>
<li>Another boolean called <code>serOK</code>. Also unclear what this
means.</li>
</ol>
</li>
</ol>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/alt_data2.html">alt_data2</a></span><span class="op">(</span><span class="va">mapped</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] "/tmp/RtmpF9gpfd/file1354a760f5e"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] 40  5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; [1] 14  1  0  0</span></span></code></pre></div>
<p>As usual, <code>altrepr</code> provides a utility function for more
easily accessing these fields:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mmap_details.html">mmap_details</a></span><span class="op">(</span><span class="va">mapped</span><span class="op">)</span></span>
<span><span class="co">#&gt; $file_name</span></span>
<span><span class="co">#&gt; [1] "/tmp/RtmpF9gpfd/file1354a760f5e"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $size_bytes</span></span>
<span><span class="co">#&gt; [1] 40</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $length</span></span>
<span><span class="co">#&gt; [1] 5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $type</span></span>
<span><span class="co">#&gt; [1] "double"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $ptrOK</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $wrtOK</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $serOK</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Michael Milton.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
