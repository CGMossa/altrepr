<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="altrepr">
<title>Intro to ALTREP and Compact Sequences • altrepr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Intro to ALTREP and Compact Sequences">
<meta property="og:description" content="altrepr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">altrepr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/altrepr.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/altrep_anatomy.html">ALTREP Anatomy</a>
    <a class="dropdown-item" href="../articles/deferred_string.html">Deferred Strings</a>
    <a class="dropdown-item" href="../articles/memmap.html">Memory Maps</a>
    <a class="dropdown-item" href="../articles/wrapper_objects.html">Wrapper Objects</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Intro to ALTREP and Compact Sequences</h1>
            
      
      
      <div class="d-none name"><code>altrepr.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="altrep-101">ALTREP 101<a class="anchor" aria-label="anchor" href="#altrep-101"></a>
</h2>
<p><em>Note: In all the <code>altrepr</code> vignettes, footnotes<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Like this one!&lt;/p&gt;"><sup>1</sup></a> are used
to point to relevant information in the R source code. A casual reader
need not follow any of these links.</em></p>
<p>ALTREP, short for alternate representation, is a mechanism where base
R and package authors can write alternative versions of some of R’s base
data types, with a different layout in memory.</p>
<p>There are many possible reasons why it might be advantageous to do
this:</p>
<ul>
<li>Data can be represented more compactly (as discussed in this
vignette)</li>
<li>Functions can reduce computation by returning lazy ALTREP results
that only evaluate entries if they are needed (see
<code><a href="../articles/deferred_string.html">vignette("deferred_string")</a></code>)</li>
<li>Metadata can be added to vectors that is invisible and un-editable
by users (see <code><a href="../articles/wrapper_objects.html">vignette("wrapper_objects")</a></code>)</li>
<li>The storage mechanism of a vector can be abstracted away, allowing
data which might not even exist in memory (see
<code><a href="../articles/memmap.html">vignette("memmap")</a></code>)</li>
</ul>
<p>At present, types that can be ALTREPPED include<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;&lt;a href="https://github.com/wch/r-source/blob/7d5117ad947beed213d3d4538bfe36441478ebef/src/main/altrep.c#L131-L137" class="external-link"&gt;altrep.c#L131-L137&lt;/a&gt;&lt;/p&gt;'><sup>2</sup></a>:</p>
<ul>
<li>Integer vectors</li>
<li>Double vectors</li>
<li>Logical vectors</li>
<li>String vectors</li>
<li>Complex vectors</li>
<li>Raw vectors</li>
<li>Lists</li>
</ul>
<p>Some more advanced data types such as environments currently can’t
have ALTREPs.</p>
<p>Although we consider ALTREPs to have a different memory
representation, in the end they are actually stored using R’s normal
SEXPREC structures like lists, environments and vectors. The difference
is that authors have the flexibility, to, for example, use a list to
represent a vector, or use several vectors to represent a single
vector.</p>
<p>Currently some of the behaviours that can be overridden in ALTREP
include<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;&lt;a href="https://github.com/wch/r-source/blob/7d5117ad947beed213d3d4538bfe36441478ebef/src/main/altrep.c#L139-L203" class="external-link"&gt;altrep.c#L139-L203&lt;/a&gt;&lt;/p&gt;'><sup>3</sup></a>:</p>
<ul>
<li>How the length is calculated (as returned by
<code><a href="https://rdrr.io/r/base/length.html" class="external-link">length()</a></code>)</li>
<li>How the data is converted to an array of data in C</li>
<li>How elements are extracted from a vector in R (using <code>[</code>
or <code>[[</code>)</li>
<li>If the array is considered sorted</li>
<li>How the minimum or maximum values of a vector are calculated</li>
</ul>
<p>You might wonder why all of this couldn’t be done with one of R’s
class systems, like S3 or S4, since they support overriding the
behaviour of <code>length</code>, <code>[</code>, <code>max</code> etc.
Some reasons include:</p>
<ul>
<li>ALTREP allows editing behaviours that cannot be edited in S3, for
example making a custom <code>DATAPTR</code>, the pointer to the vector
data.</li>
<li>Custom ALTREP state is hidden from the user (although
<code>altrepr</code> makes this less true)</li>
<li>Authors can use hacks that would break if exposed to R, such as
using a character vector containing null pointers<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;&lt;a href="https://github.com/wch/r-source/blob/7d5117ad947beed213d3d4538bfe36441478ebef/src/main/altclasses.c#L688" class="external-link"&gt;altclasses.c#L688&lt;/a&gt;&lt;/p&gt;'><sup>4</sup></a>
</li>
<li>Presumably method dispatch is faster in ALTREP because it doesn’t
involve searching the S3 method table. But this should be verified by
benchmarks.</li>
</ul>
</div>
<div class="section level2">
<h2 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<p>Let’s get hands-on with <code>altrepr</code> by looking at the
“compact sequences”, perhaps the most famous ALTREP class in R.</p>
<p>Compact sequences <a href="https://cran.r-project.org/bin/windows/base/old/3.5.0/NEWS.R-3.5.0.html" class="external-link">were
introduced in R 3.5.0</a>. They are simply integer (or double) vectors
that are represented as a “range”: they store the start, length, and
step of a sequence, rather than storing every individual element in that
range, which can save a lot of memory. Compact sequences are created by
the <code>:</code> operator, and by the <code>seq</code> family of
functions. Let’s investigate!</p>
</div>
<div class="section level2">
<h2 id="the-tip-of-the-iceberg">The Tip of the Iceberg<a class="anchor" aria-label="anchor" href="#the-tip-of-the-iceberg"></a>
</h2>
<p>To start we need to install and load the <code>altrepr</code>
package:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"multimeric/altrepr"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">altrepr</span><span class="op">)</span></span></code></pre></div>
<p>Firstly, we can use the <code><a href="../reference/is_altrep.html">is_altrep()</a></code> function to
distinguish between ALTREP and ordinary vectors:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/is_altrep.html">is_altrep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/is_altrep.html">is_altrep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/is_altrep.html">is_altrep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>Next, we can get some details about an ALTREP’s data using
<code><a href="../reference/alt_details.html">alt_details()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/alt_details.html">alt_details</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; $class_name</span></span>
<span><span class="co">#&gt; [1] "compact_intseq"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $pkg_name</span></span>
<span><span class="co">#&gt; [1] "base"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $base_type</span></span>
<span><span class="co">#&gt; [1] "integer"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $data1</span></span>
<span><span class="co">#&gt; [1] 3 1 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $data2</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<ul>
<li>
<code>class_name</code> is the human-readable class name</li>
<li>
<code>pkg_name</code> is the package where the ALTREP was
defined</li>
<li>
<code>base_type</code> is the R data type that the ALTREP is
representing</li>
</ul>
<p>We’ll go into a bit more detail about the data fields later on.</p>
<p>If we want, instead of using <code><a href="../reference/alt_details.html">alt_details()</a></code>, we can used
some more targeted functions to access these same fields:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/alt_classname.html">alt_classname</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "compact_intseq"</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/alt_pkgname.html">alt_pkgname</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "base"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="compact-real">Compact Real<a class="anchor" aria-label="anchor" href="#compact-real"></a>
</h2>
<p>There is actually another related class to
<code>compact_intseq</code>, which you can only get by converting an
intseq to double:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/alt_details.html">alt_details</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; $class_name</span></span>
<span><span class="co">#&gt; [1] "compact_realseq"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $pkg_name</span></span>
<span><span class="co">#&gt; [1] "base"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $base_type</span></span>
<span><span class="co">#&gt; [1] "double"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $data1</span></span>
<span><span class="co">#&gt; [1] 5 1 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $data2</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>This has almost all of the same properties as
<code>compact_intseq</code>, but of course it is treated as a
<code>numeric</code>/<code>real</code>/<code>double</code> by R.</p>
</div>
<div class="section level2">
<h2 id="function-naming-scheme">Function Naming Scheme<a class="anchor" aria-label="anchor" href="#function-naming-scheme"></a>
</h2>
<p>Functions in <code>altrepr</code> starting with <code>alt_</code> or
<code>is_alt_</code> relate to any ALTREP class. More specific ALTREP
classes have their own utility functions. For compact vectors, this
prefix is <code>compact_</code> and <code>is_compact</code>.</p>
<p>The first example we will see of this is a simple check for compact
vectors:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/is_compact_vec.html">is_compact_vec</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/is_compact_vec.html">is_compact_vec</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="coercing-to-a-standard-integer-vector">Coercing to a Standard Integer Vector<a class="anchor" aria-label="anchor" href="#coercing-to-a-standard-integer-vector"></a>
</h2>
<p>The ALTREP API doesn’t currently provide a function for forcing an
ALTREP vector to be converted to it’s standard representation form, but
compact vectors can be expanded using any operation that
clones/duplicates the vector.</p>
<p>The simplest way to copy a vector is to use an empty index on it
(<code>[]</code>). We can use this feature to prove the importance of
the compact sequence class, by comparing the memory usage of a
traditional integer vector, and the compact version:</p>
<p>Let’s start with an enormous vector:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">^</span><span class="fl">9</span></span>
<span><span class="fu"><a href="../reference/is_altrep.html">is_altrep</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>But even with 1 billion elements, it’s actually not very big!</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">lobstr</span><span class="fu">::</span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html" class="external-link">obj_size</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; 680 B</span></span></code></pre></div>
<p>Now let’s force the vector to expand. You will notice that this
seemingly simple operation actually takes suspiciously long. This is of
course because a 1 billion element standard representation vector is
being generated behind the scenes:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   0.782   1.088   1.869</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/is_altrep.html">is_altrep</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">lobstr</span><span class="fu">::</span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html" class="external-link">obj_size</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; 4.00 GB</span></span></code></pre></div>
<p>There we go. It’s no longer ALTREP, and we’ve worked out that we
saved about 4 GB by using ALTREP!</p>
<p>For reference, <code>altrepr</code> also provides a utility function
for this use case:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compact_to_standard.html">compact_to_standard</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/is_altrep.html">is_altrep</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">lobstr</span><span class="fu">::</span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html" class="external-link">obj_size</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; 4.00 GB</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="reading-altrep-data">Reading ALTREP Data<a class="anchor" aria-label="anchor" href="#reading-altrep-data"></a>
</h2>
<p>ALTREP classes have two “slots” for storing data (not the same as S4
slots, but it’s a helpful analogy). These are respectively called
<code>data1</code> and <code>data2</code>. These slots can store any
type of R object, including recursive types like lists, so this isn’t
really a restriction.</p>
<div class="section level3">
<h3 id="data1">
<code>data1</code><a class="anchor" aria-label="anchor" href="#data1"></a>
</h3>
<p>In the case of compact sequences, <code>data1</code> is used to store
the parameters of the sequence as a double (not integer!) vector</p>
<ul>
<li>The first entry contains the length of the sequence</li>
<li>The second entry contains the start value of the sequence</li>
<li>The third entry contains the step, which is currently always 1 or
-1</li>
</ul>
<p>We can prove all this using the <code><a href="../reference/alt_data1.html">alt_data1()</a></code>
function:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/alt_data1.html">alt_data1</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3 1 1</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/alt_data1.html">alt_data1</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2 2 1</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/alt_data1.html">alt_data1</a></span><span class="op">(</span><span class="fl">3</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  2  3 -1</span></span></code></pre></div>
<p>Actually <code>altrepr</code> has a utility function for finding this
information, specifically for compact vectors:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/compact_details.html">compact_details</a></span><span class="op">(</span><span class="fl">4</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; $length</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $start</span></span>
<span><span class="co">#&gt; [1] 4</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $step</span></span>
<span><span class="co">#&gt; [1] -1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $expanded</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="data2-and-the-expanded-form">
<code>data2</code> and the Expanded Form<a class="anchor" aria-label="anchor" href="#data2-and-the-expanded-form"></a>
</h3>
<p>Compact seqs are considered to start in “compact” form, which we can
see at the very end of the output from <code><a href="../reference/alt_inspect.html">alt_inspect()</a></code>. This
function prints some internal information about the altrep vector which
often seems to be informative when dealing with built-in ALTREP
types:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span></span>
<span><span class="fu"><a href="../reference/alt_inspect.html">alt_inspect</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; @55e9271c4e00 13 INTSXP g0c0 [REF(65535)]  1 : 3 (compact)</span></span></code></pre></div>
<p>“compact” means that <code>data2</code> is <code>NULL</code>, which
is its initial value:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/alt_data2.html">alt_data2</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>A shortcut method to check for this is
<code>compact_is_expanded</code>:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/compact_is_expanded.html">compact_is_expanded</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<p>When the <code>DATAPTR</code> of the sequence is accessed (which is a
pointer to the array of data in the vector), it forces the compact
sequence to expand. <code>altrepr</code> has a special built-in function
that forces a compact vector to expand without any other side
effects:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/compact_expand.html">compact_expand</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/alt_inspect.html">alt_inspect</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; @55e9271c4e00 13 INTSXP g0c0 [REF(65535)]  1 : 3 (expanded)</span></span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/compact_is_expanded.html">compact_is_expanded</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>Notably <code>x</code> is <em>still</em> ALTREP, it hasn’t been
coerced into a standard representation vector:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/is_altrep.html">is_altrep</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>But the <code>data2</code> value, which is linked to the expanded
form, is now set to a full vector of integer data:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/alt_data2.html">alt_data2</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1 2 3</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="modifying-altrep-data">Modifying ALTREP Data<a class="anchor" aria-label="anchor" href="#modifying-altrep-data"></a>
</h2>
<p><strong>Note: improperly modifying ALTREP data can be potentially
very dangerous and will risk crashing or corrupting your R session if
done incorrectly!</strong>.</p>
<p><code>altrepr</code> also provides <code>set_alt_data1</code> and
<code>set_alt_data2</code> for modifying the ALTREP data. As an example,
let’s create a compact range and then modify it. This is safe because
we’re replacing a double vector with another double vector that follows
the same layout as described above.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span></span>
<span><span class="fu"><a href="../reference/set_alt_data1.html">set_alt_data1</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x</span></span>
<span><span class="co">#&gt; [1] 3 4</span></span></code></pre></div>
<p>Firstly note that we’ve taken the range <code>1:5</code> and replaced
it with <code>3:4</code>, because we set the start of the range to be 3,
and the length of it to be 2.</p>
<p>Also, importantly, note that <strong><code>x</code> has been modified
in-place</strong>. As noted above, any copy of a compact sequence will
no longer be ALTREP. This means that there’s actually no way to make a
modified copy of <code>x</code> as in normal R.</p>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Michael Milton.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
